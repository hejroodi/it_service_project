{% extends 'tickets/dashboard_base.html' %}
{% block title %}Ù¾Ù†Ù„ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ IT{% endblock %}

{% block content %}
{{ block.super }}

<!-- Ø¨Ø®Ø´ Ø§Ø®ØªØµØ§ØµÛŒ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ -->
<div class="card p-3 shadow-sm mt-4">
    <h5 class="fw-bold mb-3">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµâ€ŒÛŒØ§ÙØªÙ‡ Ø¨Ù‡ Ù…Ù†</h5>
    <div id="tickets-table">
        {% include 'tickets/_expert_table.html' %}
    </div>

    <!-- Ø¯Ú©Ù…Ù‡ Ú¯Ø±ÙØªÙ† Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
    <div class="mt-3">
        <button onclick="askNotificationPermission()" class="btn btn-warning">ğŸ”” ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</button>
    </div>
</div>

<!-- ğŸ”¹ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù‡Ø§ -->
<script>
function refreshExpertTable(){
    fetch("{% url 'expert_dashboard_table' %}")
    .then(response => response.json())
    .then(data => {
        document.getElementById("tickets-table").innerHTML = data.html;
    });
}
// Ù‡Ø± 60 Ø«Ø§Ù†ÛŒÙ‡ Ø±ÙØ±Ø´ Ø¬Ø¯ÙˆÙ„
setInterval(refreshExpertTable, 60000);

function askNotificationPermission(){
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
            if(permission === "granted"){
                alert("âœ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯.");
            }
        });
    }
}

function checkForNewExpertTickets() {
    fetch("{% url 'check_new_expert_tickets' %}")
    .then(response => response.json())
    .then(data => {
        data.forEach(t => {
            if (Notification.permission === "granted") {
                new Notification("ğŸ“¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯", {
                    body: `${t.title} (${t.status})`,
                    icon: "/static/images/alert-icon.png",
                    requireInteraction: true
                });
            }
            fetch("{% url 'mark_expert_notified' 0 %}".replace('0', t.id));
        });
    });
}
// Ù‡Ø± 10 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
setInterval(checkForNewExpertTickets, 10000);
</script>
{% endblock %}