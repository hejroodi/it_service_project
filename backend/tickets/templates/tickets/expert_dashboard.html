{% extends 'tickets/base.html' %}
{% block content %}

<h2>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹â€ŒØ´Ø¯Ù‡ Ø¨Ù‡ Ù…Ù†</h2>

<div id="tickets-table">
    {% include 'tickets/_expert_table.html' %}
</div>

<script>
function refreshExpertTable(){
    fetch("{% url 'expert_dashboard_table' %}")
    .then(response => response.json())
    .then(data => {
        document.getElementById("tickets-table").innerHTML = data.html;
    });
}
setInterval(refreshExpertTable, 60000); // Ù‡Ø± 1 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ©Ø¨Ø§Ø±
</script>

<!-- Ø¯Ú©Ù…Ù‡ Ú¯Ø±ÙØªÙ† Ù…Ø¬ÙˆØ² Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
<button onclick="askNotificationPermission()">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</button>


<script>
let notifiedTicketIds = [];

function askNotificationPermission(){
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
            if(permission === "granted"){
                alert("âœ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯.");
            }
        });
    }
}

function checkForNewExpertTickets() {
    fetch("{% url 'check_new_expert_tickets' %}")
    .then(response => response.json())
    .then(data => {
        data.forEach(t => {
            if (Notification.permission === "granted") {
                new Notification("ğŸ“¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯", {
                    body: `${t.title} (${t.status})`,
                    icon: "/static/images/alert-icon.png",
                    requireInteraction: true // ØªØ§ Ø¨Ø³ØªÙ‡ Ù†Ø´ÙˆØ¯ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
                });
            }
            // Ø¨Ø¹Ø¯ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø±ØŒ Ø«Ø¨Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            fetch("{% url 'mark_expert_notified' 0 %}".replace('0', t.id));
        });
    });
}

setInterval(checkForNewExpertTickets, 10000);
</script>

{% endblock %}