{% extends 'tickets/base.html' %}
{% block title %}Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± IT{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ² Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
    if (Notification.permission !== "granted") {
        Notification.requestPermission();
    }
});
</script>

{% block content %}
<h2>Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</h2>
<a href="{% url 'manager_reports' %}" class="btn btn-info mb-3">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</a>


<h2>Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</h2>

<!-- Ù†Ø§Ø­ÛŒÙ‡ Ø¬Ø¯ÙˆÙ„ Ú©Ù‡ Ø¨Ø§ AJAX Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒØ´Ù‡ -->
<div id="tickets-table">
    {% include 'tickets/_manager_table.html' %}
</div>

<script>
function refreshManagerTable(){
    fetch("{% url 'manager_dashboard_table' %}")
    .then(response => response.json())
    .then(data => {
        document.getElementById("tickets-table").innerHTML = data.html;
    });
}
// Ù‡Ø± 60 Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
setInterval(refreshManagerTable, 60000);
</script>

<button onclick="askNotificationPermission()">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</button>

<script>
function askNotificationPermission(){
    // Ø§Ú¯Ø± Ù…Ø¬ÙˆØ² Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø¯Ù‡
    if (Notification.permission !== "granted") {
        Notification.requestPermission().then(permission => {
            if(permission === "granted"){
                alert("âœ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ÙØ¹Ø§Ù„ Ø´Ø¯ØŒ Ø§Ø² Ø§ÛŒÙ† Ù¾Ø³ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯");
            } else {
                alert("âŒ Ù…Ø¬ÙˆØ² Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ú©Ø§Ø± Ù†Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.");
            }
        });
    } else {
        alert("Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ ÛŒØ§ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.");
    }
}
</script>

<script>
function checkForNewManagerTickets() {
    fetch("{% url 'check_new_tickets' %}")
    .then(response => response.json())
    .then(data => {
        if (data.new_tickets > 0) {
            if (Notification.permission === "granted") {
                new Notification("ğŸ“¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯", {
                    body: `ØªØ¹Ø¯Ø§Ø¯ ${data.new_tickets} Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.`,
                    icon: "/static/images/alert-icon.png",
                    requireInteraction: true // ğŸ”¹ ØªØ§ ÙˆÙ‚ØªÛŒ Ø¨Ø³ØªÙ‡ Ù†Ø´Ù‡ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…ÙˆÙ†Ù‡
                });
            }
        }
    });
}
setInterval(checkForNewManagerTickets, 60000);
</script>

{% endblock %}