<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>عنوان</th>
            <th>درخواست‌دهنده</th>
            <th>واحد</th>
            <th>نوع خدمت</th>
            <th>توضیحات</th>
            <th>تاریخ ثبت</th>
            <th>وضعیت</th>
            <th>ارجاع به کارشناس</th>
        </tr>
    </thead>
    <tbody>
    {% for t in tickets %}
    <tr>
        {% comment %} این ستون‌ها برای همه وضعیت‌ها رنگ شفاف دارن {% endcomment %}
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.title }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.requester.get_full_name }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.requester.unit.name }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.service_type.name }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.description }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.created_at|date:"Y-m-d H:i" }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">{{ t.get_status_display }}</td>
        <td style="{% if t.status == 'done' %}background-color: rgba(40, 167, 69, 0.15) !important;{% elif t.status == 'in_progress' %}background-color: rgba(220, 53, 69, 0.15) !important;{% else %}background-color: rgba(23, 162, 184, 0.15) !important;{% endif %}">
            <!-- فرم ارجاع به کارشناس -->
            {% if t.status != 'done' %}
            <form method="post" action="{% url 'assign_expert' t.id %}">
                {% csrf_token %}
                <select name="expert_id" class="form-select form-select-sm">
                    {% for e in experts %}
                        <option value="{{ e.id }}" {% if t.assigned_to and e.id == t.assigned_to.id %}selected{% endif %}>
                            {% if e.get_full_name %}{{ e.get_full_name }}{% else %}{{ e.username }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-sm btn-primary mt-1">ارجاع</button>
            </form>
            {% else %}
                کامل شده
            {% endif %}
        </td>
    </tr>
    {% empty %}
    <tr><td colspan="8" class="text-center">هیچ درخواست ثبت نشده است.</td></tr>
    {% endfor %}
    </tbody>
</table>