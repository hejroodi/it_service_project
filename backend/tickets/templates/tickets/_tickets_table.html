{% load custom_tags %}
<table class="table table-striped table-bordered">
    <thead>
        <tr>
            {% if user|has_group:"User" %}
                <th>عنوان درخواست</th>
                <th>توضیحات</th>
                <th>واحد</th>
                <th>نوع خدمت</th>
                <th>وضعیت</th>
                <th>در کارتابل چه کسی</th>
                <th>قبل از من چند درخواست است</th>
            {% elif user|has_group:"Manager" %}
                <th>عنوان</th>
                <th>درخواست‌دهنده</th>
                <th>واحد</th>
                <th>نوع خدمت</th>
                <th>توضیحات</th>
                <th>تاریخ ثبت</th>
                <th>وضعیت</th>
                <th>ارجاع به کارشناس</th>
            {% elif user|has_group:"Expert" %}
                <th>عنوان</th>
                <th>درخواست‌دهنده</th>
                <th>واحد</th>
                <th>نوع خدمت</th>
                <th>توضیحات</th>
                <th>تاریخ ثبت</th>
                <th>وضعیت</th>
                <th>اقدام</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
    {% for t in tickets %}
    <tr>
        {% if user|has_group:"User" %}
            <td>{{ t.title }}</td>
            <td>{{ t.description }}</td>
            <td>{{ t.unit.name }}</td>
            <td>{{ t.service_type.name }}</td>
            <td>{{ t.get_status_display }}</td>
            <td>{% if t.assigned_to %}{{ t.assigned_to.get_full_name }}{% else %}ارجاع نشده{% endif %}</td>
            <td>{% if t.before_count is not None %}{{ t.before_count }}{% else %}-{% endif %}</td>

        {% elif user|has_group:"Manager" %}
            <td>{{ t.title }}</td>
            <td>{{ t.requester.get_full_name }}</td>
            <td>{{ t.requester.unit.name }}</td>
            <td>{{ t.service_type.name }}</td>
            <td>{{ t.description }}</td>
            <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ t.get_status_display }}</td>
            <td>
                {% if t.status != 'done' %}
                    <form method="post" action="{% url 'assign_expert' t.id %}">
                        {% csrf_token %}
                        <select name="expert_id" class="form-select form-select-sm">
                            {% for e in experts %}
                                <option value="{{ e.id }}" {% if t.assigned_to and e.id == t.assigned_to.id %}selected{% endif %}>
                                    {{ e.get_full_name|default:e.username }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary mt-1">ارجاع</button>
                    </form>
                {% else %}
                    کامل شده
                {% endif %}
            </td>

        {% elif user|has_group:"Expert" %}
            <td>{{ t.title }}</td>
            <td>{{ t.requester.get_full_name }}</td>
            <td>{{ t.requester.unit.name }}</td>
            <td>{{ t.service_type.name }}</td>
            <td>{{ t.description }}</td>
            <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ t.get_status_display }}</td>
            <td>
                {% if t.status != 'done' %}
                    <form method="post" action="{% url 'mark_done' t.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-sm">اتمام کار</button>
                    </form>
                {% else %}
                    انجام شده
                {% endif %}
            </td>
        {% endif %}
    </tr>
    {% empty %}
    <tr>
        <td colspan="{% if user|has_group:"User" %}7{% elif user|has_group:"Manager" %}8{% else %}8{% endif %}" class="text-center">
            هیچ درخواست ثبت نشده است.
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>